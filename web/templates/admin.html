{% extends "base.html" %}
{% block title %}Admin Panel - MCP Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-gear-fill"></i> Admin Panel</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

{% if 'admin' not in session.user.roles %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> You don't have permission to access this page.
</div>
{% else %}

<div class="row">
    <!-- System Status -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> System Status</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-6">Server Version:</dt>
                    <dd class="col-sm-6">1.0.0</dd>
                    
                    <dt class="col-sm-6">Python Version:</dt>
                    <dd class="col-sm-6">{{ python_version }}</dd>
                    
                    <dt class="col-sm-6">Flask Version:</dt>
                    <dd class="col-sm-6">{{ flask_version }}</dd>
                    
                    <dt class="col-sm-6">Uptime:</dt>
                    <dd class="col-sm-6">{{ uptime }}</dd>
                    
                    <dt class="col-sm-6">Memory Usage:</dt>
                    <dd class="col-sm-6">{{ memory_usage }} MB</dd>
                    
                    <dt class="col-sm-6">CPU Usage:</dt>
                    <dd class="col-sm-6">{{ cpu_usage }}%</dd>
                </dl>
            </div>
        </div>
        
        <!-- User Management -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> User Management</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="bi bi-person-plus"></i> Add User
                </button>
                
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Roles</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.full_name }}</td>
                                <td>
                                    {% for role in user.roles %}
                                    <span class="badge bg-{{ 'warning' if role == 'admin' else 'secondary' }}">
                                        {{ role }}
                                    </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editUser('{{ user.id }}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user.id }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tool Management -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-tools"></i> Tool Management</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success mb-3" onclick="reloadAllTools()">
                    <i class="bi bi-arrow-repeat"></i> Reload All Tools
                </button>
                <button class="btn btn-warning mb-3" onclick="clearToolCache()">
                    <i class="bi bi-trash"></i> Clear Tool Cache
                </button>
                
                <div class="list-group">
                    {% for tool_name in tools %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ tool_name }}</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary" onclick="viewToolConfig('{{ tool_name }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-warning" onclick="reloadTool('{{ tool_name }}')">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                            <button class="btn btn-danger" onclick="disableTool('{{ tool_name }}')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Configuration -->
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Configuration</h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="mb-3">
                        <label class="form-label">Registry Reload Interval (seconds)</label>
                        <input type="number" class="form-control" id="reloadInterval" value="{{ config.reload_interval }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Call History</label>
                        <input type="number" class="form-control" id="maxCallHistory" value="{{ config.max_call_history }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Error History</label>
                        <input type="number" class="form-control" id="maxErrorHistory" value="{{ config.max_error_history }}">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-terminal"></i> System Logs</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-sm btn-secondary" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="clearLogs()">
                        <i class="bi bi-trash"></i> Clear Logs
                    </button>
                </div>
                <div class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto; font-family: monospace;">
                    <pre id="systemLogs">{{ logs }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="newFullName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="user" id="roleUser" checked>
                            <label class="form-check-label" for="roleUser">User</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="admin" id="roleAdmin">
                            <label class="form-check-label" for="roleAdmin">Admin</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewUser()">Save User</button>
            </div>
        </div>
    </div>
</div>

{% endif %}

<script>
function reloadAllTools() {
    if (!confirm('Are you sure you want to reload all tools?')) return;
    
    $.post('/api/admin/reload-all-tools')
        .done(function(data) {
            alert('All tools reloaded successfully');
            location.reload();
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to reload tools'));
        });
}

function reloadTool(toolName) {
    $.post(`/api/tool/${toolName}/reload`)
        .done(function(data) {
            alert(`Tool ${toolName} reloaded successfully`);
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to reload tool'));
        });
}

function clearToolCache() {
    if (!confirm('Are you sure you want to clear the tool cache?')) return;
    
    $.post('/api/admin/clear-cache')
        .done(function(data) {
            alert('Cache cleared successfully');
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to clear cache'));
        });
}

function viewToolConfig(toolName) {
    window.location.href = `/tool/${toolName}`;
}

function disableTool(toolName) {
    if (!confirm(`Are you sure you want to disable ${toolName}?`)) return;
    
    $.post(`/api/admin/disable-tool/${toolName}`)
        .done(function(data) {
            alert(`Tool ${toolName} disabled`);
            location.reload();
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to disable tool'));
        });
}

function saveNewUser() {
    const roles = [];
    if ($('#roleUser').is(':checked')) roles.push('user');
    if ($('#roleAdmin').is(':checked')) roles.push('admin');
    
    const userData = {
        id: $('#newUsername').val(),
        full_name: $('#newFullName').val(),
        password: $('#newPassword').val(),
        roles: roles
    };
    
    $.post('/api/admin/add-user', userData)
        .done(function(data) {
            alert('User added successfully');
            $('#addUserModal').modal('hide');
            location.reload();
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to add user'));
        });
}

function editUser(userId) {
    // Implementation for editing user
    alert('Edit user: ' + userId);
}

function deleteUser(userId) {
    if (!confirm(`Are you sure you want to delete user ${userId}?`)) return;
    
    $.ajax({
        url: `/api/admin/delete-user/${userId}`,
        method: 'DELETE'
    })
    .done(function(data) {
        alert('User deleted successfully');
        location.reload();
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to delete user'));
    });
}

function refreshLogs() {
    $.get('/api/admin/logs')
        .done(function(data) {
            $('#systemLogs').text(data.logs);
        })
        .fail(function(xhr) {
            alert('Error fetching logs');
        });
}

function clearLogs() {
    if (!confirm('Are you sure you want to clear the logs?')) return;
    
    $.post('/api/admin/clear-logs')
        .done(function(data) {
            alert('Logs cleared');
            $('#systemLogs').text('');
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to clear logs'));
        });
}

$('#configForm').on('submit', function(e) {
    e.preventDefault();
    
    const configData = {
        reload_interval: $('#reloadInterval').val(),
        max_call_history: $('#maxCallHistory').val(),
        max_error_history: $('#maxErrorHistory').val()
    };
    
    $.post('/api/admin/update-config', configData)
        .done(function(data) {
            alert('Configuration updated successfully');
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to update configuration'));
        });
});

// Auto-refresh logs every 10 seconds
setInterval(refreshLogs, 10000);
</script>
{% endblock %}