{% extends "base.html" %}
{% block title %}Dashboard - MCP Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-speedometer2"></i> MCP Tools Dashboard</h2>
    <div>
        <button class="btn btn-success" onclick="refreshStats()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        {% if 'admin' in session.user.roles %}
        <button class="btn btn-warning" onclick="reloadAllTools()">
            <i class="bi bi-bootstrap-reboot"></i> Reload All Tools
        </button>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-tools"></i> Total Tools
                </h5>
                <h2 class="mb-0">{{ stats.tools_loaded }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-telephone-outbound"></i> Total Calls
                </h5>
                <h2 class="mb-0">{{ stats.global_call_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-exclamation-circle"></i> Total Errors
                </h5>
                <h2 class="mb-0">{{ stats.global_error_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-check-circle"></i> Active Tools
                </h5>
                <h2 class="mb-0">{{ tools|length }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0"><i class="bi bi-list"></i> Available Tools</h4>
            </div>
            <div class="card-body">
                <!-- Table Controls -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <label class="me-2 mb-0" style="white-space: nowrap;">Show</label>
                            <select id="rowsPerPage" class="form-select form-select-sm" style="width: auto;">
                                <option value="10">10</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                            <label class="ms-2 mb-0" style="white-space: nowrap;">entries</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text"
                                   id="toolSearch"
                                   class="form-control"
                                   placeholder="Filter by tool name or module...">
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="clearSearch()">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tools Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="toolsTable">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" onclick="sortTable(0)">
                                    Tool Name <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortTable(1)">
                                    Module <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortTable(2)">
                                    Status <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th style="cursor: pointer;" onclick="sortTable(3)">
                                    Calls <i class="bi bi-arrow-down-up"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="toolsTableBody">
                            {% for tool_name in tools %}
                            <tr class="tool-row"
                                data-tool-name="{{ tool_name|lower }}"
                                data-module="{{ stats.tool_statistics.get(tool_name, {}).get('name', 'N/A')|lower }}">
                                <td>
                                    <i class="bi bi-plugin"></i>
                                    <strong>{{ tool_name }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ stats.tool_statistics.get(tool_name, {}).get('name', 'N/A') }}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="bi bi-circle-fill"></i> Active
                                    </span>
                                </td>
                                <td data-sort-value="{{ stats.tool_statistics.get(tool_name, {}).get('total_calls', 0) }}">
                                    <span class="badge bg-secondary">
                                        {{ stats.tool_statistics.get(tool_name, {}).get('total_calls', 0) }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('tool_detail', tool_name=tool_name) }}"
                                           class="btn btn-primary"
                                           title="View Details">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                        <button class="btn btn-info"
                                                onclick="testTool('{{ tool_name }}')"
                                                title="Test Tool">
                                            <i class="bi bi-play"></i> Test
                                        </button>
                                        {% if 'admin' in session.user.roles %}
                                        <button class="btn btn-warning"
                                                onclick="reloadTool('{{ tool_name }}')"
                                                title="Reload Tool">
                                            <i class="bi bi-arrow-repeat"></i> Reload
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Table Info and Pagination -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="dataTables_info" id="tableInfo">
                            Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span>
                            of <span id="totalEntries">{{ tools|length }}</span> entries
                            <span id="filteredInfo" style="display: none;">
                                (filtered from <span id="totalTools">{{ tools|length }}</span> total entries)
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <nav aria-label="Table pagination">
                            <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                                <!-- Pagination will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.recent_calls %}
                <ul class="list-group list-group-flush">
                    {% for call in stats.recent_calls[-5:] %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <small>
                                <i class="bi bi-dot"></i>
                                <strong>{{ call.tool }}</strong>.{{ call.method }}
                            </small>
                            <small class="text-muted">
                                {% if call.success %}
                                <span class="text-success">✓</span>
                                {% else %}
                                <span class="text-danger">✗</span>
                                {% endif %}
                            </small>
                        </div>
                        <small class="text-muted">{{ call.timestamp }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">No recent activity</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Recent Errors</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.recent_errors %}
                <ul class="list-group list-group-flush">
                    {% for error in stats.recent_errors[-5:] %}
                    <li class="list-group-item">
                        <div>
                            <small>
                                <strong>{{ error.tool }}</strong>.{{ error.method }}
                            </small>
                        </div>
                        <small class="text-danger">{{ error.error[:100] }}...</small>
                        <br>
                        <small class="text-muted">{{ error.timestamp }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">No recent errors</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Test Tool Modal -->
<div class="modal fade" id="testToolModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Tool: <span id="testToolName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testToolForm">
                    <div class="mb-3">
                        <label class="form-label">Method Name</label>
                        <input type="text" class="form-control" id="methodName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Arguments (JSON)</label>
                        <textarea class="form-control" id="arguments" rows="4" placeholder='{"key": "value"}'>{}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-circle"></i> Execute
                    </button>
                </form>
                <hr>
                <div id="testResults" style="display: none;">
                    <h6>Results:</h6>
                    <pre id="testResultsContent"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .pagination {
        margin-bottom: 0;
    }

    .dataTables_info {
        padding-top: 0.5rem;
        font-size: 0.875rem;
        color: #6c757d;
    }

    #toolSearch {
        max-width: 400px;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 10;
    }

    .tool-row.hidden {
        display: none;
    }

    th[onclick] {
        user-select: none;
    }

    th[onclick]:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
// Pagination and filtering state
let currentPage = 1;
let rowsPerPage = 50;
let allRows = [];
let filteredRows = [];
let sortColumn = -1;
let sortAscending = true;

// Initialize on page load
$(document).ready(function() {
    allRows = Array.from(document.querySelectorAll('.tool-row'));
    filteredRows = [...allRows];
    updateTable();

    // Event listeners
    $('#rowsPerPage').on('change', function() {
        rowsPerPage = this.value === 'all' ? filteredRows.length : parseInt(this.value);
        currentPage = 1;
        updateTable();
    });

    $('#toolSearch').on('keyup', function() {
        filterTable(this.value);
    });
});

// Filter table by search term
function filterTable(searchTerm) {
    searchTerm = searchTerm.toLowerCase().trim();

    if (searchTerm === '') {
        filteredRows = [...allRows];
    } else {
        filteredRows = allRows.filter(row => {
            const toolName = row.getAttribute('data-tool-name');
            const module = row.getAttribute('data-module');
            return toolName.includes(searchTerm) || module.includes(searchTerm);
        });
    }

    currentPage = 1;
    updateTable();

    // Show/hide filtered info
    if (filteredRows.length < allRows.length) {
        $('#filteredInfo').show();
        $('#totalTools').text(allRows.length);
    } else {
        $('#filteredInfo').hide();
    }
}

// Clear search
function clearSearch() {
    $('#toolSearch').val('');
    filterTable('');
}

// Sort table by column
function sortTable(columnIndex) {
    // Toggle sort direction if same column
    if (sortColumn === columnIndex) {
        sortAscending = !sortAscending;
    } else {
        sortColumn = columnIndex;
        sortAscending = true;
    }

    filteredRows.sort((a, b) => {
        let aValue, bValue;

        if (columnIndex === 3) {
            // Numeric sort for Calls column
            aValue = parseInt(a.cells[columnIndex].getAttribute('data-sort-value')) || 0;
            bValue = parseInt(b.cells[columnIndex].getAttribute('data-sort-value')) || 0;
        } else {
            // Text sort
            aValue = a.cells[columnIndex].textContent.trim().toLowerCase();
            bValue = b.cells[columnIndex].textContent.trim().toLowerCase();
        }

        if (aValue < bValue) return sortAscending ? -1 : 1;
        if (aValue > bValue) return sortAscending ? 1 : -1;
        return 0;
    });

    currentPage = 1;
    updateTable();
}

// Update table display
function updateTable() {
    const tbody = document.getElementById('toolsTableBody');
    const totalRows = filteredRows.length;

    // Calculate pagination
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = rowsPerPage === totalRows ? totalRows : Math.min(startIndex + rowsPerPage, totalRows);

    // Hide all rows first
    allRows.forEach(row => {
        row.classList.add('hidden');
    });

    // Show only rows for current page
    for (let i = startIndex; i < endIndex; i++) {
        filteredRows[i].classList.remove('hidden');
    }

    // Reorder rows in tbody
    filteredRows.forEach(row => {
        tbody.appendChild(row);
    });

    // Update info text
    $('#totalEntries').text(totalRows);
    $('#showingStart').text(totalRows === 0 ? 0 : startIndex + 1);
    $('#showingEnd').text(endIndex);

    // Update pagination
    updatePagination(totalRows);
}

// Update pagination controls
function updatePagination(totalRows) {
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    if (totalPages <= 1) {
        return; // No pagination needed
    }

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
    </a>`;
    pagination.appendChild(prevLi);

    // Page numbers
    const maxPagesToShow = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

    // Adjust if we're near the end
    if (endPage - startPage < maxPagesToShow - 1) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }

    // First page
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1); return false;">1</a>`;
        pagination.appendChild(firstLi);

        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
            pagination.appendChild(ellipsisLi);
        }
    }

    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }

    // Last page
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<a class="page-link" href="#">...</a>`;
            pagination.appendChild(ellipsisLi);
        }

        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>`;
        pagination.appendChild(lastLi);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
    </a>`;
    pagination.appendChild(nextLi);
}

// Change page
function changePage(page) {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    if (page < 1 || page > totalPages) return;

    currentPage = page;
    updateTable();

    // Scroll to top of table
    document.getElementById('toolsTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Existing functions
function refreshStats() {
    window.location.reload();
}

function reloadTool(toolName) {
    if (!confirm(`Are you sure you want to reload ${toolName}?`)) return;

    $.post(`/api/tool/${toolName}/reload`)
        .done(function(data) {
            alert(data.message);
            refreshStats();
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to reload tool'));
        });
}

function reloadAllTools() {
    if (!confirm('Are you sure you want to reload all tools?')) return;

    const tools = {{ tools | tojson }};
    let reloadPromises = tools.map(tool =>
        $.post(`/api/tool/${tool}/reload`)
    );

    Promise.all(reloadPromises)
        .then(() => {
            alert('All tools reloaded successfully');
            refreshStats();
        })
        .catch((error) => {
            alert('Some tools failed to reload');
            refreshStats();
        });
}

function testTool(toolName) {
    $('#testToolName').text(toolName);
    $('#testResults').hide();
    $('#testToolModal').modal('show');
}

$('#testToolForm').on('submit', function(e) {
    e.preventDefault();

    const toolName = $('#testToolName').text();
    const methodName = $('#methodName').val();
    let args;

    try {
        args = JSON.parse($('#arguments').val());
    } catch (e) {
        alert('Invalid JSON in arguments');
        return;
    }

    $.ajax({
        url: `/api/tool/${toolName}/call`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            method: methodName,
            arguments: args
        }),
        success: function(data) {
            $('#testResultsContent').text(JSON.stringify(data, null, 2));
            $('#testResults').show();
        },
        error: function(xhr) {
            $('#testResultsContent').text('Error: ' + JSON.stringify(xhr.responseJSON, null, 2));
            $('#testResults').show();
        }
    });
});

// Auto-refresh every 30 seconds
setInterval(function() {
    $.get('/api/stats')
        .done(function(data) {
            // Update stats without full page reload
            console.log('Stats updated:', data);
        });
}, 30000);
</script>
{% endblock %}