{% extends "base.html" %}
{% block title %}Dashboard - MCP Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-speedometer2"></i> MCP Tools Dashboard</h2>
    <div>
        <button class="btn btn-success" onclick="refreshStats()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        {% if 'admin' in session.user.roles %}
        <button class="btn btn-warning" onclick="reloadAllTools()">
            <i class="bi bi-bootstrap-reboot"></i> Reload All Tools
        </button>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-tools"></i> Total Tools
                </h5>
                <h2 class="mb-0">{{ stats.tools_loaded }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-telephone-outbound"></i> Total Calls
                </h5>
                <h2 class="mb-0">{{ stats.global_call_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-exclamation-circle"></i> Total Errors
                </h5>
                <h2 class="mb-0">{{ stats.global_error_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-check-circle"></i> Active Tools
                </h5>
                <h2 class="mb-0">{{ tools|length }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0"><i class="bi bi-list"></i> Available Tools</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="toolsTable">
                        <thead>
                            <tr>
                                <th>Tool Name</th>
                                <th>Module</th>
                                <th>Status</th>
                                <th>Calls</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tool_name in tools %}
                            <tr>
                                <td>
                                    <i class="bi bi-plugin"></i> 
                                    <strong>{{ tool_name }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ stats.tool_statistics.get(tool_name, {}).get('name', 'N/A') }}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="bi bi-circle-fill"></i> Active
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ stats.tool_statistics.get(tool_name, {}).get('total_calls', 0) }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('tool_detail', tool_name=tool_name) }}" 
                                           class="btn btn-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                        <button class="btn btn-info" 
                                                onclick="testTool('{{ tool_name }}')">
                                            <i class="bi bi-play"></i> Test
                                        </button>
                                        {% if 'admin' in session.user.roles %}
                                        <button class="btn btn-warning" 
                                                onclick="reloadTool('{{ tool_name }}')">
                                            <i class="bi bi-arrow-repeat"></i> Reload
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.recent_calls %}
                <ul class="list-group list-group-flush">
                    {% for call in stats.recent_calls[-5:] %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <small>
                                <i class="bi bi-dot"></i>
                                <strong>{{ call.tool }}</strong>.{{ call.method }}
                            </small>
                            <small class="text-muted">
                                {% if call.success %}
                                <span class="text-success">✓</span>
                                {% else %}
                                <span class="text-danger">✗</span>
                                {% endif %}
                            </small>
                        </div>
                        <small class="text-muted">{{ call.timestamp }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">No recent activity</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Recent Errors</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if stats.recent_errors %}
                <ul class="list-group list-group-flush">
                    {% for error in stats.recent_errors[-5:] %}
                    <li class="list-group-item">
                        <div>
                            <small>
                                <strong>{{ error.tool }}</strong>.{{ error.method }}
                            </small>
                        </div>
                        <small class="text-danger">{{ error.error[:100] }}...</small>
                        <br>
                        <small class="text-muted">{{ error.timestamp }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">No recent errors</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Test Tool Modal -->
<div class="modal fade" id="testToolModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Tool: <span id="testToolName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testToolForm">
                    <div class="mb-3">
                        <label class="form-label">Method Name</label>
                        <input type="text" class="form-control" id="methodName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Arguments (JSON)</label>
                        <textarea class="form-control" id="arguments" rows="4" placeholder='{"key": "value"}'>{}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-circle"></i> Execute
                    </button>
                </form>
                <hr>
                <div id="testResults" style="display: none;">
                    <h6>Results:</h6>
                    <pre id="testResultsContent"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshStats() {
    window.location.reload();
}

function reloadTool(toolName) {
    if (!confirm(`Are you sure you want to reload ${toolName}?`)) return;
    
    $.post(`/api/tool/${toolName}/reload`)
        .done(function(data) {
            alert(data.message);
            refreshStats();
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to reload tool'));
        });
}

function reloadAllTools() {
    if (!confirm('Are you sure you want to reload all tools?')) return;
    
    const tools = {{ tools | tojson }};
    let reloadPromises = tools.map(tool => 
        $.post(`/api/tool/${tool}/reload`)
    );
    
    Promise.all(reloadPromises)
        .then(() => {
            alert('All tools reloaded successfully');
            refreshStats();
        })
        .catch((error) => {
            alert('Some tools failed to reload');
            refreshStats();
        });
}

function testTool(toolName) {
    $('#testToolName').text(toolName);
    $('#testResults').hide();
    $('#testToolModal').modal('show');
}

$('#testToolForm').on('submit', function(e) {
    e.preventDefault();
    
    const toolName = $('#testToolName').text();
    const methodName = $('#methodName').val();
    let args;
    
    try {
        args = JSON.parse($('#arguments').val());
    } catch (e) {
        alert('Invalid JSON in arguments');
        return;
    }
    
    $.ajax({
        url: `/api/tool/${toolName}/call`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            method: methodName,
            arguments: args
        }),
        success: function(data) {
            $('#testResultsContent').text(JSON.stringify(data, null, 2));
            $('#testResults').show();
        },
        error: function(xhr) {
            $('#testResultsContent').text('Error: ' + JSON.stringify(xhr.responseJSON, null, 2));
            $('#testResults').show();
        }
    });
});

// Auto-refresh every 30 seconds
setInterval(function() {
    $.get('/api/stats')
        .done(function(data) {
            // Update stats without full page reload
            console.log('Stats updated:', data);
        });
}, 30000);
</script>
{% endblock %}